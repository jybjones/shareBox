From b7f064706f07dd43e6c00cc0df8d02bb696c391a Mon Sep 17 00:00:00 2001
From: Dustin Pate <noirsoldats@gmail.com>
Date: Fri, 18 Sep 2015 00:44:12 -0500
Subject: [PATCH] Adding Backend Profile Features and Angular Routes and stuff

---
 .gitignore                          |   3 +
 app/controllers/index.js            |  20 +++++--
 app/routes/profile.server.routes.js |   8 +--
 app/views/includes/foot.jade        |   2 +
 config/config.js                    |   4 +-
 config/env/development.js           |   2 +-
 public/js/config.js                 |   3 +
 public/js/controllers/profile.js    | 114 ++++++++++++++++++++----------------
 public/js/services/profile.js       |  29 ++++++---
 public/views/header.html            |   4 +-
 public/views/profile/show.html      |  13 ++++
 11 files changed, 130 insertions(+), 72 deletions(-)
 create mode 100644 public/views/profile/show.html

diff --git a/.gitignore b/.gitignore
index 303f76a..fc80b6a 100644
--- a/.gitignore
+++ b/.gitignore
@@ -26,6 +26,9 @@ public/lib
 test/coverage/
 migrations/
 
+# Secret Settings File IgnoreS
+secret/
+
 *.local
 
 # IDE files
diff --git a/app/controllers/index.js b/app/controllers/index.js
index c94351c..32f7eb3 100644
--- a/app/controllers/index.js
+++ b/app/controllers/index.js
@@ -2,11 +2,23 @@
  * Module dependencies.
  */
 var _ = require('lodash');
+var db = require('../../config/sequelize');
 
 
 exports.render = function(req, res) {
-    // The Index is the Jade index
-    res.render('index', {
-        user: req.user ? JSON.stringify(req.user) : "null"
-    });
+    if(req.user) {
+        db.User.find({where: {id: req.user.id}, include: [{model: db.userProfile, as: 'Profile'}]}).then(function (user) {
+            if (!user) {
+                return next(new Error('Failed to load profile for logged in user.'));
+            } else {
+                res.render('index', {
+                    user: JSON.stringify(user)
+                });
+            }
+        });
+    }else{
+        res.render('index', {
+            user: "null"
+        });
+    }
 };
diff --git a/app/routes/profile.server.routes.js b/app/routes/profile.server.routes.js
index c7f386d..68789af 100644
--- a/app/routes/profile.server.routes.js
+++ b/app/routes/profile.server.routes.js
@@ -7,15 +7,15 @@
 var users = require('../../app/controllers/users'),
 profile = require('../../app/controllers/profile');
 
-module.exports = function(app, express) {
-
+module.exports = function(app) {
+// Article Routes
 app.route('/api/profile')
     .get(users.requiresLogin, profile.loadUserProfile, profile.show)
     .put(users.requiresLogin, profile.loadUserProfile, profile.update);
 app.route('/api/profile/:profileId')
     .get(profile.showPublic);
-   // .put(users.requiresLogin, items.hasAuthorization, items.update)
-   // .delete(users.requiresLogin, items.hasAuthorization, items.destroy);
+//    .put(users.requiresLogin, items.hasAuthorization, items.update)
+//    .delete(users.requiresLogin, items.hasAuthorization, items.destroy);
 
 // Finish with setting up the articleId param
 // Note: the articles.article function will be called everytime then it will call the next function.
diff --git a/app/views/includes/foot.jade b/app/views/includes/foot.jade
index 119bcb7..47d0d48 100755
--- a/app/views/includes/foot.jade
+++ b/app/views/includes/foot.jade
@@ -18,12 +18,14 @@ script(type='text/javascript', src='/js/filters.js')
 //Application Services
 script(type='text/javascript', src='/js/services/global.js')
 script(type='text/javascript', src='/js/services/articles.js')
+script(type='text/javascript', src='/js/services/profile.js')
 
 //Application Controllers
 script(type='text/javascript', src='/js/controllers/articles.js')
 script(type='text/javascript', src='/js/controllers/profile.js')
 script(type='text/javascript', src='/js/controllers/index.js')
 script(type='text/javascript', src='/js/controllers/header.js')
+script(type='text/javascript', src='/js/controllers/profile.js')
 script(type='text/javascript', src='/js/init.js')
 
 if (process.env.NODE_ENV == 'development')
diff --git a/config/config.js b/config/config.js
index fab1bc9..0cef02f 100644
--- a/config/config.js
+++ b/config/config.js
@@ -8,7 +8,9 @@ module.exports = _.assign(
 	// configuration variables that will be the same across all environments
     require(__dirname + '/../config/env/all.js'),
     // configuration variables that are environment specific
-    require(__dirname + '/../config/env/' + process.env.NODE_ENV + '.js') || {}
+    require(__dirname + '/../config/env/' + process.env.NODE_ENV + '.js') || {},
+	// Config Variables in secrets.js
+	require(__dirname + '/../config/env/secret/secrets.js') || {}
 );
 
 /**
diff --git a/config/env/development.js b/config/env/development.js
index 067f016..f1272ab 100644
--- a/config/env/development.js
+++ b/config/env/development.js
@@ -25,4 +25,4 @@ module.exports = {
         realm: "http://localhost:3000/",
         callbackURL: "http://localhost:3000/auth/google/callback"
     }
-}
+};
diff --git a/public/js/config.js b/public/js/config.js
index 65b7eb4..7c21437 100644
--- a/public/js/config.js
+++ b/public/js/config.js
@@ -2,6 +2,9 @@
 angular.module('sharebox').config(['$routeProvider',
     function($routeProvider) {
         $routeProvider.
+        when('/profile', {
+            templateUrl: 'views/profile/show.html'
+        }).
         when('/articles', {
             templateUrl: 'views/articles/list.html'
         }).
diff --git a/public/js/controllers/profile.js b/public/js/controllers/profile.js
index 088275d..b5cb6bc 100644
--- a/public/js/controllers/profile.js
+++ b/public/js/controllers/profile.js
@@ -1,61 +1,71 @@
-angular.module('sharebox.profile').controller('profileController', ['$scope', '$routeParams', '$location', 'Global', function ($scope, $routeParams, $location, Global) {
+angular.module('sharebox.profile').controller('ProfileController', ['$scope', '$routeParams', '$location', 'Global', 'Profile', function ($scope, $routeParams, $location, Global, Profile) {
     $scope.global = Global;
+    //
+    //$scope.create = function() {
+    //    var article = new Articles({
+    //        title: this.title,
+    //        content: this.content
+    //    });
+    //
+    //    article.$save(function(response) {
+    //        console.log(response);
+    //        $location.path("articles/" + response.id);
+    //    });
+    //
+    //    this.title = "";
+    //    this.content = "";
+    //};
+    //
+    //$scope.remove = function(article) {
+    //    if (article) {
+    //        article.$remove();
+    //
+    //        for (var i in $scope.articles) {
+    //            if ($scope.articles[i] == article) {
+    //                $scope.articles.splice(i, 1);
+    //            }
+    //        }
+    //    }
+    //    else {
+    //        $scope.article.$remove();
+    //        $location.path('articles');
+    //    }
+    //};
+    //
+    //$scope.update = function() {
+    //    var article = $scope.article;
+    //    if (!article.updated) {
+    //        article.updated = [];
+    //    }
+    //    article.updated.push(new Date().getTime());
+    //
+    //    article.$update(function() {
+    //        $location.path('articles/' + article.id);
+    //    });
+    //};
 
-    $scope.create = function() {
-        var profile = new Profile({
-            firstName: this.firstName,
-            lastName: this.lastName,
-            content: this.content
+    $scope.show = function() {
+        Profile.getProfile().success(function(profile){
+            $scope.profile = profile;
+        }).error(function(err){
+            // Error State
         });
-
-        profile.$save(function(response) {
-            console.log(response);
-            $location.path("profile/" + response.id);
-        });
-
-        this.firstName = "";
-        this.content = "";
-    };
-
-    $scope.remove = function(profile) {
-        if (profile) {
-            profile.$remove();
-
-            for (var i in $scope.profile) {
-                if ($scope.profile[i] == profile) {
-                    $scope.profile.splice(i, 1);
-                }
-            }
-        }
-        else {
-            $scope.profile.$remove();
-            $location.path('profile');
-        }
     };
 
-    $scope.update = function() {
-        var profile = $scope.profile;
-        if (!profile.updated) {
-            profile.updated = [];
-        }
-        article.updated.push(new Date().getTime());
-
-        article.$update(function() {
-            $location.path('articles/' + article.id);
-        });
-    };
-
-    $scope.find = function() {
-        Articles.query(function(articles) {
-            $scope.articles = articles;
+    $scope.updateProfile = function(profile) {
+        Profile.updateProfile(profile).success(function(profile){
+            // Put redirect to show here.
+            $scope.profile = profile;
+        }).error(function(err){
+            // Error State
         });
     };
 
-    $scope.findOne = function() {
-        Articles.get({
-            articleId: $routeParams.articleId
-        }, function(article) {
-            $scope.article = article;
-        });
-    };
+    //$scope.findOne = function() {
+    //    Articles.get({
+    //        articleId: $routeParams.articleId
+    //    }, function(article) {
+    //        $scope.article = article;
+    //    });
+    //};
 }]);
diff --git a/public/js/services/profile.js b/public/js/services/profile.js
index 81507b3..5295def 100644
--- a/public/js/services/profile.js
+++ b/public/js/services/profile.js
@@ -1,10 +1,23 @@
 //Articles service used for articles REST endpoint
-angular.module('sharebox.profile').factory("profile", ['$resource', function($resource) {
-    return $resource('profile/:profileId', {
-        profileId: '@id'
-    }, {
-        update: {
-            method: 'PUT'
-        }
-    });
+angular.module('sharebox.profile').factory("Profile", ['$http', function($http) {
+    //return $resource('api/profile/:profileId', {
+    //    profileId: '@id'
+    //}, {
+    //    update: {
+    //        method: 'PUT'
+    //    }
+    //});
+
+    var urlBase = '/api/profile';
+    var profileFactory = {};
+
+    profileFactory.getProfile = function(){
+        return $http.get(urlBase);
+    };
+
+    profileFactory.updateProfile = function(profile){
+        return $http.put(urlBase, profile);
+    };
+
+    return profileFactory;
 }]);
diff --git a/public/views/header.html b/public/views/header.html
index 48be12a..dffa737 100644
--- a/public/views/header.html
+++ b/public/views/header.html
@@ -1,7 +1,7 @@
 <div class="navbar-inner" data-ng-controller="HeaderController">
     <ul class="nav">
         <li>
-            <a class="brand" href=" {{ global.authenticated ? '/#!/home' : '/#!/'}}"> Sh@reBox</a>
+            <a class="brand" href="{{ global.authenticated ? '/#!/home' : '/#!/' }}">Sh@reBox</a>
         </li>
         <li data-ng-repeat="item in menu" data-ng-show="global.user" ui-route="/{{item.link}}" ng-class="{active: $uiRoute}">
             <a href="#!/{{item.link}}">{{item.title}}</a>
@@ -17,7 +17,7 @@
     <ul class="nav pull-right" data-ng-show="global.authenticated">
         <li class="dropdown">
             <a href="#" class="dropdown-toggle" data-toggle="dropdown">
-				{{global.user.name}} <b class="caret"></b>
+				{{global.user.Profile.firstName ? global.user.Profile.firstName : global.user.email}} <b class="caret"></b>
 			</a>
             <ul class="dropdown-menu">
                 <li><a href="/#!/profile">Profile</a>
diff --git a/public/views/profile/show.html b/public/views/profile/show.html
new file mode 100644
index 0000000..247c09d
--- /dev/null
+++ b/public/views/profile/show.html
@@ -0,0 +1,13 @@
+<section data-ng-controller="ProfileController" data-ng-init="show()">
+	SOMETHING IS HERE!!
+	{{ profile.firstName }} {{ profile.lastName }}
+	<!--<ul class="articles unstyled">-->
+		<!--<li data-ng-repeat="article in articles">-->
+			<!--<span>{{article.updatedAt | date:'medium'}}</span> /-->
+			<!--<span>{{article.user.name}}</span>-->
+			<!--<h2><a data-ng-href="#!/articles/{{article.id}}">{{article.title}}</a></h2>-->
+			<!--<div>{{article.content}}</div>-->
+		<!--</li>-->
+	<!--</ul>-->
+	<!--<h1 data-ng-hide="!articles || articles.length">No articles yet. <br> Why don't you <a href="/#!/articles/create">Create One</a>?</h1>-->
+</section>
\ No newline at end of file
-- 
1.8.2.1

